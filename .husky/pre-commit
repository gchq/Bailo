#!/bin/sh

# Run lint-staged for TypeScript frontend + backend
echo "Running TypeScript/JavaScript lint-staged checks..."
npx lint-staged || exit 1

# Try to find and activate a Python virtual environment
VENV_ACTIVATED=false
for venv_dir in $(find . -maxdepth 3 -type d \( -name 'venv' -o -name '.venv' -o -name '*env' \) -not -path '*/node_modules/*' | sort); do
    if [ -f "$venv_dir/bin/activate" ]; then
        echo "Activating Python virtual environment at $venv_dir"
        . "$venv_dir/bin/activate"
        VENV_ACTIVATED=true
        break
    fi
done

# Determine Python command from current environment (venv or system)
PYTHON_CMD=$(command -v python3 || command -v python)

if [ -n "$PYTHON_CMD" ]; then
  echo "Python detected: $($PYTHON_CMD --version)"

  # Check if 'pre-commit' is installed
  if $PYTHON_CMD -m pre_commit --version >/dev/null 2>&1; then
    echo "Running Python pre-commit hooks..."
    $PYTHON_CMD -m pre_commit run --files $(git diff --cached --name-only)
  else
    echo "'pre-commit' not installed. Skipping Python linting."
    if [ "$VENV_ACTIVATED" = true ]; then
      echo "To enable, run: pip install pre-commit (inside the virtual environment)"
    else
      echo "To enable, run: pip install pre-commit"
    fi
  fi
else
  echo "Python not found. Skipping Python linting."
fi
