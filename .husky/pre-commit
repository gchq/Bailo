#!/bin/sh

# ---- Typescript Linting ----

# Run lint-staged for TypeScript frontend + backend
echo "Running TypeScript/JavaScript lint-staged checks..."
npx lint-staged || exit 1

# Try to find and activate a Python virtual environment
VENV_ACTIVATED=false
for venv_dir in $(find . -maxdepth 3 -type d \( -name 'venv' -o -name '.venv' -o -name '*env' \) -not -path '*/node_modules/*' | sort); do
    if [ -f "$venv_dir/bin/activate" ]; then
        echo "Activating Python virtual environment at $venv_dir"
        . "$venv_dir/bin/activate"
        VENV_ACTIVATED=true
        break
    fi
done

# ---- Python Linting ----

# Determine Python command from current environment (venv or system)
PYTHON_CMD=$(command -v python3 || command -v python)

if [ -n "$PYTHON_CMD" ]; then
  echo "Python detected: $($PYTHON_CMD --version)"

  # Check if 'pre-commit' is installed
  if $PYTHON_CMD -m pre_commit --version >/dev/null 2>&1; then
    echo "Running Python pre-commit hooks..."
    $PYTHON_CMD -m pre_commit run --files $(git diff --cached --name-only)
  else
    echo "'pre-commit' not installed. Skipping Python linting."
    if [ "$VENV_ACTIVATED" = true ]; then
      echo "To enable, run: pip install pre-commit (inside the virtual environment)"
    else
      echo "To enable, run: pip install pre-commit"
    fi
  fi
else
  echo "Python not found. Skipping Python linting."
fi

# ---- Ripgrep Keyword Check ----

# Load local Husky config
HUSKY_CONFIG_FILE="$(git rev-parse --show-toplevel)/.husky/husky-config.conf"

if [ -f "$HUSKY_CONFIG_FILE" ]; then
  . "$HUSKY_CONFIG_FILE"
else
  echo "ERROR: $HUSKY_CONFIG_FILE not found."
  echo "Create it locally (it is gitignored)."
  exit 1
fi

# Validate USE_S3 is set
if [ -z "${USE_S3:-}" ]; then
  echo "ERROR: USE_S3 is not set in husky-config.conf (true|false)"
  exit 1
fi

TMP_KEYWORDS_FILE=""

if [ "$USE_S3" = "true" ]; then
  # --- S3 mode ---

  # Validate KEYWORDS_S3_URI is set
  if [ -z "${KEYWORDS_S3_URI:-}" ]; then
    echo "ERROR: KEYWORDS_S3_URI is not set in husky-config.conf"
    exit 1
  fi

  TMP_KEYWORDS_FILE="$(mktemp)"

  echo "Fetching keywords from S3..."
  echo "$KEYWORDS_S3_URI"

  if ! aws s3 cp "$KEYWORDS_S3_URI" "$TMP_KEYWORDS_FILE" --quiet; then
    echo "ERROR: Failed to fetch keywords file from S3. Ensure you have pasted in your AWS login command."
    rm -f "$TMP_KEYWORDS_FILE"
    exit 1
  fi

else
  # --- Local file mode ---

  if [ -z "${KEYWORDS_FILEPATH:-}" ]; then
    echo "ERROR: KEYWORDS_FILEPATH is not set in husky-config.conf"
    exit 1
  fi

  # Resolve relative paths from repo root
  REPO_ROOT="$(git rev-parse --show-toplevel)"
  TMP_KEYWORDS_FILE="$REPO_ROOT/$KEYWORDS_FILEPATH"

  if [ ! -f "$TMP_KEYWORDS_FILE" ]; then
    echo "ERROR: Local keywords file not found: $TMP_KEYWORDS_FILE"
    exit 1
  fi

  echo "Using local keywords file:"
  echo "$TMP_KEYWORDS_FILE"
fi

# Run ripgrep
echo "Scanning repository for keywords..."

if rg \
  -n \
  -F \
  -f "$TMP_KEYWORDS_FILE" \
  --glob '!:node_modules/**' \
  --glob '!:.husky/**' \
  ..
then
  echo ""
  echo "ERROR: Keywords detected."
  [ "$USE_S3" = "true" ] && rm -f "$TMP_KEYWORDS_FILE"
  exit 1
fi

# Cleanup (only for S3 temp file)
[ "$USE_S3" = "true" ] && rm -f "$TMP_KEYWORDS_FILE"

echo "Pre-commit check passed."


# ---- Optional: Trufflehog Check - if enabled ----

RUN_TRUFFLE_HOGGING="${RUN_TRUFFLE_HOGGING:-false}"

# Validate RUN_TRUFFLE_HOGGING is set
if [ -z "${RUN_TRUFFLE_HOGGING:-}" ]; then
  echo "ERROR: RUN_TRUFFLE_HOGGING is not set in husky-config.conf (true|false)"
  exit 1
fi

# Check if we need to run
if [ "$RUN_TRUFFLE_HOGGING" != "true" ]; then
  echo "TruffleHog disabled (RUN_TRUFFLE=$RUN_TRUFFLE_HOGGING)"
  exit 0
fi

echo "Running TruffleHog..."

# Get staged files only
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Exit early if nothing to scan
[ -z "$STAGED_FILES" ] && exit 0

# Create a temp directory
TMP_DIR=$(mktemp -d)

# Copy staged files to temp dir (preserves content exactly as committed)
for file in $STAGED_FILES; do
  mkdir -p "$TMP_DIR/$(dirname "$file")"
  git show ":$file" > "$TMP_DIR/$file" 2>/dev/null || true
done

# Run Trufflehog
RESULT=$(trufflehog filesystem "$TMP_DIR" \
  --no-update \
  --json)

# Clean up
rm -rf "$TMP_DIR"

# Check for findings
if echo "$RESULT" | grep -q '"Verified":true'; then
  echo "Verified secret detected. Commit blocked."
  echo
  echo "$RESULT" | jq -r '.DetectorName + " in " + .SourceMetadata.Data.File'
  exit 1
fi

echo "No verified secrets found."
exit 0
